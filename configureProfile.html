<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editing Profile...</title>
</head>
<body>
    <div>
        <form id="ProfileForm">
            <h3>Editing Profile...</h3>
      
            <!--Text area to enter bio-->
            <div>
              <h3>Bio:</h3>
              <textarea placeholder="Write a quick bio to tell others about yourself!" id="bioInp"></textarea>
            </div>
      
            <!--Checkboxes to select availability-->
            <div>
              <h3>Availability:</h3>
              <input type="checkbox" id="monday" name="days" value="Monday">
              <label for="monday">Monday</label><br>
              <input type="checkbox" id="tuesday" name="days" value="Tuesday">
              <label for="tuesday">Tuesday</label><br>
              <input type="checkbox" id="wednesday" name="days" value="Wednesday">
              <label for="wednesday">Wednesday</label><br>
              <input type="checkbox" id="thursday" name="days" value="Thursday">
              <label for="thursday">Thursday</label><br>
              <input type="checkbox" id="friday" name="days" value="Friday">
              <label for="friday">Friday</label><br>
              <input type="checkbox" id="saturday" name="days" value="Saturday">
              <label for="saturday">Saturday</label><br>
              <input type="checkbox" id="sunday" name="days" value="Sunday">
              <label for="sunday">Sunday</label><br>
            </div>
      
      
            <!--Section to get pet information-->
            <div>
              <h3>Info:</h3>
              <div>
                  <!-- Pet's Type -->
                <h5>Pet Type:</h5>
                <input type="radio" id="cat" name="pettype" value="Cat">
                <label for="cat">Cat</label><br>
                <input type="radio" id="dog" name="pettype" value="Dog">
                <label for="dog">Dog</label><br>
              </div>
              <!-- Pet's Gender -->
              <div>
                <h5>Gender:</h5>
                <input type="radio" id="female" name="gender" value="Female">
                <label for="female">Female</label><br>
                <input type="radio" id="male" name="gender" value="Male">
                <label for="male">Male</label><br>
              </div>
              <!-- Pet's Age -->
              <div>
                  <h5>Age:</h5>
                  <input type="text" id="petAge" pattern="[0-9]*" oninput="this.value = this.value.replace(/[^0-9]/g, '')" placeholder="Enter pet's age (in numbers)">
                  <input type="radio" id="months" name="ageUnit" value="months">
                  <label for="months">Months</label>
                  <input type="radio" id="years" name="ageUnit" value="years">
                  <label for="years">Years</label>
              </div>
              <!-- Pet's Size -->
              <div>
                  <h5>Size:</h5>
                  <input type="radio" id="small" name="size" value="Small">
                  <label for="small">Small</label><br>
                  <input type="radio" id="medium" name="size" value="Medium">
                  <label for="medium">Medium</label><br>
                  <input type="radio" id="large" name="size" value="Large">
                  <label for="large">Large</label><br>
              </div>
              <!-- Pet's Vaccination Status -->
              <div>
                  <h5>Vaccinated:</h5>
                  <input type="radio" id="yes" name="vacc" value="Yes">
                  <label for="yes">Yes</label><br>
                  <input type="radio" id="no" name="vacc" value="No">
                  <label for="no">No</label><br>
              </div>
              <!-- Pet's Neutered/Spayed Status -->
              <div>
                  <h5>Neutered/Spayed:</h5>
                  <input type="radio" id="yes" name="neuSpa" value="Yes">
                  <label for="yes">Yes</label><br>
                  <input type="radio" id="no" name="neuSpa" value="No">
                  <label for="no">No</label><br>
              </div>
            </div>
            <button type="submit" id="saveProfBtn">Save</button> <!--Button to save changes-->
            <button type="button" id="cancelBtn">Cancel</button> <!--Button to cancel changes-->
        </form>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-app.js";
        import { getDatabase, ref, update, get} from "https://www.gstatic.com/firebasejs/10.5.2/firebase-database.js";
        import { getAuth, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCE4N3-_icVHFbWLWI9rqO_E-uXwqB67rk",
            authDomain: "pawmates-a1757.firebaseapp.com",
            databaseURL: "https://pawmates-a1757-default-rtdb.firebaseio.com",
            projectId: "pawmates-a1757",
            storageBucket: "pawmates-a1757.appspot.com",
            messagingSenderId: "212632097126",
            appId: "1:212632097126:web:bb4518a57e31549c2178a7"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getDatabase();
        const auth = getAuth(app);

        let bioInp = document.getElementById('bioInp');
        let ProfileForm = document.getElementById('ProfileForm');

        const SaveProfile = (evt) => {
            evt.preventDefault();

            const user = auth.currentUser;

            if (user) {
                const userRef = ref(db, 'Users/' + user.uid);
                const daysOfWeek = []; // Array to store selected days

                document.querySelectorAll('input[name="days"]:checked').forEach((checkbox) => {
                    daysOfWeek.push(checkbox.value);
                });

                const selectedGender = document.querySelector('input[name="gender"]:checked');
                const selectedPetType = document.querySelector('input[name="pettype"]:checked');
                const selectedSize = document.querySelector('input[name="size"]:checked');
                const selectedVacc = document.querySelector('input[name="vacc"]:checked');
                const selectedNeuSpa = document.querySelector('input[name="neuSpa"]:checked');
                const petAge = document.getElementById('petAge').value;
                const ageUnit = document.querySelector('input[name="ageUnit"]:checked')?.value || '';

                // Validation: Check if pet's age is entered but age unit is not selected
                if (petAge && !ageUnit) {
                    alert('Please select the age unit (Months/Years) for the pet\'s age.');
                    return; // Prevent form submission
                }

                // Update user data including bio, availability and pet info
                update(userRef, {
                    Bio: bioInp.value,
                    AvailableDays: daysOfWeek,
                    Gender: selectedGender ? selectedGender.value : null,
                    PetType: selectedPetType ? selectedPetType.value : null,
                    Size: selectedSize ? selectedSize.value : null,
                    Vaccinated: selectedVacc ? selectedVacc.value : null,
                    NeuteredSpayed: selectedNeuSpa ? selectedNeuSpa.value : null,
                    PetAge: petAge,
                    AgeUnit: ageUnit
                })
                .then(() => {
                    window.location.href = 'profile.html';
                })
                .catch((error) => {
                    alert(error.message);
                });
            } else {
                console.log('User not logged in.');
            }
        };

        // Function to handle canceling edits
        const CancelEdit = () => {
            window.location.href = 'profile.html'; // Redirect to the profile page without saving changes
        };

        // Fetch user profile data if available and pre-fill the form fields
        const fetchProfileData = (user) => {
            const userRef = ref(db, `Users/${user.uid}`);
            get(userRef)
            .then((snapshot) => {
                if (snapshot.exists()) {
                    const userData = snapshot.val();
                    bioInp.value = userData.Bio || '';

                    // Fetch and pre-fill days of the week checkboxes
                    const daysOfWeek = userData.AvailableDays || [];
                    daysOfWeek.forEach(day => {
                        const checkbox = document.getElementById(day.toLowerCase());
                        if (checkbox) {
                            checkbox.checked = true;
                        }
                    });

                    //Fetch and pre-fill pet type, gender, size, vacc, and neuSpa data
                    const selectedPetType = userData.PetType || '';
                    const selectedGender = userData.Gender || '';
                    const selectedSize = userData.Size || '';
                    const selectedVacc = userData.Vaccinated || '';
                    const selectedNeuSpa = userData.NeuteredSpayed || '';

                    //Check and set the selected pet type radio button
                    const petTypeRadio = document.querySelector(`input[name="pettype"][value="${selectedPetType}"]`);
                    if (petTypeRadio) {
                        petTypeRadio.checked = true;
                    }

                    //Check and set the selected gender radio button
                    const genderRadio = document.querySelector(`input[name="gender"][value="${selectedGender}"]`);
                    if (genderRadio) {
                        genderRadio.checked = true;
                    }

                    //Check and set the selected size radio button
                    const sizeRadio = document.querySelector(`input[name="size"][value="${selectedSize}"]`);
                    if (sizeRadio) {
                        sizeRadio.checked = true;
                    }

                    //Check and set the selected vaccinated radio button
                    const vaccRadio = document.querySelector(`input[name="vacc"][value="${selectedVacc}"]`);
                    if (vaccRadio) {
                        vaccRadio.checked = true;
                    }

                    //Check and set the selected neutered/spayed radio button
                    const neuSpaRadio = document.querySelector(`input[name="neuSpa"][value="${selectedNeuSpa}"]`);
                    if (neuSpaRadio) {
                        neuSpaRadio.checked = true;
                    }

                    // Fetch and pre-fill pet's age and age unit data
                    const petAge = userData.PetAge || '';
                    const ageUnit = userData.AgeUnit || '';
                    document.getElementById('petAge').value = petAge;

                    const selectedAgeUnit = document.querySelector(`input[name="ageUnit"][value="${ageUnit}"]`);
                    if (selectedAgeUnit) {
                        selectedAgeUnit.checked = true;
                    }
                } else {
                    console.log('No data available for the user.');
                }
            })
            .catch((error) => {
                console.error('Error fetching user profile data:', error);
            });
        };

        // Fetch and pre-fill profile data when the user is authenticated
        const onAuthStateChangedCallback = (user) => {
            if (user) {
                fetchProfileData(user);
            } else {
                console.log('User not logged in.');
            }
        };

        // Listen for changes in authentication state
        const unsubscribe = auth.onAuthStateChanged(onAuthStateChangedCallback);


        // Add event listener to the cancel button
        const cancelBtn = document.getElementById('cancelBtn');
        cancelBtn.addEventListener('click', CancelEdit);

        // Add event listener to the profile form
        ProfileForm.addEventListener('submit', SaveProfile);
    </script>
    </body>
</html>
