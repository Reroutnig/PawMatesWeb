<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editing Profile...</title>
</head>
<body>
    <div>
        <form id="ProfileForm">
            <h3>Editing Profile...</h3>

            <!--Text area to enter bio-->
            <textarea placeholder="Write a quick bio to tell others about yourself!" id="bioInp"></textarea>

            <!--Checkboxes to select availability-->
            <h3>Select available days:</h3>
            <label for="monday">Monday</label>
            <input type="checkbox" id="monday" name="days" value="Monday">
            <label for="tuesday">Tuesday</label>
            <input type="checkbox" id="tuesday" name="days" value="Tuesday">
            <label for="wednesday">Wednesday</label>
            <input type="checkbox" id="wednesday" name="days" value="Wednesday">
            <label for="thursday">Thursday</label>
            <input type="checkbox" id="thursday" name="days" value="Thursday">
            <label for="friday">Friday</label>
            <input type="checkbox" id="friday" name="days" value="Friday">
            <label for="saturday">Saturday</label>
            <input type="checkbox" id="saturday" name="days" value="Saturday">
            <label for="sunday">Sunday</label>
            <input type="checkbox" id="sunday" name="days" value="Sunday">


            <button type="submit" id="saveProfBtn">Save</button> <!--Button to save changes-->
            <button type="button" id="cancelBtn">Cancel</button> <!--Button to cancel changes-->
        </form>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-app.js";
        import { getDatabase, ref, update, get} from "https://www.gstatic.com/firebasejs/10.5.2/firebase-database.js";
        import { getAuth, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCE4N3-_icVHFbWLWI9rqO_E-uXwqB67rk",
            authDomain: "pawmates-a1757.firebaseapp.com",
            databaseURL: "https://pawmates-a1757-default-rtdb.firebaseio.com",
            projectId: "pawmates-a1757",
            storageBucket: "pawmates-a1757.appspot.com",
            messagingSenderId: "212632097126",
            appId: "1:212632097126:web:bb4518a57e31549c2178a7"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getDatabase();
        const auth = getAuth(app);

        let bioInp = document.getElementById('bioInp');
        let ProfileForm = document.getElementById('ProfileForm');

        const SaveProfile = (evt) => {
            evt.preventDefault();

            const user = auth.currentUser;

            if (user) {
                const userRef = ref(db, 'Users/' + user.uid);
                const daysOfWeek = []; // Array to store selected days

                // Get selected days
                document.querySelectorAll('input[name="days"]:checked').forEach((checkbox) => {
                    daysOfWeek.push(checkbox.value);
                });

                // Update user data including bio and selected days
                update(userRef, {
                    Bio: bioInp.value,
                    AvailableDays: daysOfWeek
                })
                .then(() => {
                    window.location.href = 'profile.html'; // Redirect to the profile page
                })
                .catch((error) => {
                    alert(error.message);
                });
            } else {
                console.log('User not logged in.');
            }
        };

        // Function to handle canceling edits
        const CancelEdit = () => {
            window.location.href = 'profile.html'; // Redirect to the profile page without saving changes
        };

        // Fetch user profile data if available and pre-fill the form fields
        const fetchProfileData = (user) => {
            const userRef = ref(db, `Users/${user.uid}`);
            get(userRef)
            .then((snapshot) => {
                if (snapshot.exists()) {
                    const userData = snapshot.val();
                    bioInp.value = userData.Bio || '';

                    if (userData.AvailableDays && userData.AvailableDays.length > 0) {
                        userData.AvailableDays.forEach((day) => {
                            const checkbox = document.getElementById(day.toLowerCase());
                            if (checkbox) {
                                checkbox.checked = true;
                            }
                        });
                    }
                } else {
                    console.log('No data available for the user.');
                }
            })
            .catch((error) => {
                console.error('Error fetching user profile data:', error);
            });
        };

        // Fetch and pre-fill profile data when the user is authenticated
        const onAuthStateChangedCallback = (user) => {
            if (user) {
                fetchProfileData(user);
            } else {
                console.log('User not logged in.');
            }
        };

        // Listen for changes in authentication state
        const unsubscribe = auth.onAuthStateChanged(onAuthStateChangedCallback);


        // Add event listener to the cancel button
        const cancelBtn = document.getElementById('cancelBtn');
        cancelBtn.addEventListener('click', CancelEdit);

        // Add event listener to the profile form
        ProfileForm.addEventListener('submit', SaveProfile);
    </script>
    </body>
</html>